<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaani - Your Voice Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Status Indicator -->
    <div class="status-indicator" id="status-indicator">
        üü¢ Online
    </div>
    
    <div class="main-container">
        <!-- Left Sidebar for History -->
        <div class="sidebar">
            <h2>History</h2>
            <ul id="history-list">
                <!-- History items will be dynamically added here -->
            </ul>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Heading -->
            <header>
                <h1>Vaani - Your Voice Assistant</h1>
                <p style="font-size: 0.9rem; color: #666;">‡§µ‡§æ‡§£‡•Ä - ‡§Ü‡§™‡§ï‡§æ ‡§Ü‡§µ‡§æ‡§ú ‡§∏‡§π‡§æ‡§Ø‡§ï</p>
            </header>

            <!-- Add a line above the microphone -->
            <div class="help-text">
                
                <p>‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•ç‡§Ø‡§æ ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Ç?</p>
            </div>

            <!-- Existing microphone section -->
            <div class="mic-section">
                <button id="mic-btn" class="mic-btn" title="Tap to Speak">
                    üé§
                </button>
                <p class="mic-instruction">Tap the mic and speak</p>
            </div>

            <!-- Add a search box below the microphone -->
            <div class="search-box">
                <input type="text" id="search-input" class="search-input" placeholder="Ask anything...">
            </div>

            <!-- Response display area -->
            <div id="response-area" class="response-area" style="display: none;">
                <div class="response-content">
                    <p id="response-text"></p>
                    <!-- Audio player for responses -->
                    <audio id="audio-player" controls style="display: none; width: 100%; margin-top: 15px;"></audio>
                </div>
            </div>

            <!-- Quick Action Icons -->
            <div class="quick-actions">
                <div class="action-card" onclick="sendQuickQuery('Weather')">
                    üå§Ô∏è
                    <p>Weather</p>
                    <small>‡§Æ‡•å‡§∏‡§Æ</small>
                </div>
                <div class="action-card" onclick="sendQuickQuery('News')">
                    üì∞
                    <p>News</p>
                    <small>‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞</small>
                </div>
                <div class="action-card" onclick="sendQuickQuery('Schemes')">
                    üí∞
                    <p>Schemes</p>
                    <small>‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç</small>
                </div>
                <div class="action-card" onclick="sendQuickQuery('Emergency')">
                    üö®
                    <p>Emergency</p>
                    <small>‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤</small>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sessionId = 'user_' + Date.now(); // Generate unique session ID
        let isFirstMicClick = true; // Track first mic click
        
        // Test API connection on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, session ID:', sessionId);
            
            // Check API status
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    console.log('API Status:', data);
                    updateStatusIndicator(data.online);
                })
                .catch(error => {
                    console.error('API Status check failed:', error);
                    updateStatusIndicator(false);
                });
            
            fetch('/api/test')
                .then(response => response.json())
                .then(data => {
                    console.log('API Test Success:', data);
                })
                .catch(error => {
                    console.error('API Test Failed:', error);
                    alert('Warning: Could not connect to backend API. Please check if the server is running.');
                });
        });
        
        // Update status indicator
        function updateStatusIndicator(isOnline) {
            const indicator = document.getElementById('status-indicator');
            if (isOnline) {
                indicator.textContent = 'üü¢ Online';
                indicator.classList.remove('offline');
            } else {
                indicator.textContent = 'üî¥ Offline Mode';
                indicator.classList.add('offline');
            }
        }

        // Handle microphone button click
        document.getElementById('mic-btn').addEventListener('click', () => {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in your browser. Please use Chrome or Edge.');
                return;
            }
            
            // Show greeting on first mic click
            if (isFirstMicClick) {
                console.log('First mic click - showing greeting');
                isFirstMicClick = false;
                
                // Show greeting immediately
                const greeting = "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§µ‡§æ‡§£‡•Ä ‡§π‡•Ç‡§Ç, ‡§Ü‡§™‡§ï‡•Ä ‡§Ü‡§µ‡§æ‡§ú ‡§∏‡§π‡§æ‡§Ø‡§ï‡•§ ‡§Ü‡§™ ‡§Æ‡•Å‡§ù‡§∏‡•á ‡§Æ‡•å‡§∏‡§Æ, ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞, ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç ‡§î‡§∞ ‡§¨‡§π‡•Å‡§§ ‡§ï‡•Å‡§õ ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§";
                showGreeting(greeting);
                
                // Fetch greeting with audio
                fetch('/api/greeting')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Greeting response:', data);
                        if (data.success && data.audio_file) {
                            console.log('Playing greeting audio:', data.audio_file);
                            playAudioResponse(data.audio_file);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching greeting:', error);
                    });
                
                // Wait for greeting to play, then start recognition
                setTimeout(() => {
                    console.log('Starting voice recognition after greeting...');
                    startVoiceRecognition();
                }, 3000);
                
                return;
            }
            
            startVoiceRecognition();
        });
        
        function startVoiceRecognition() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            
            // Support both Hindi and English
            recognition.lang = 'hi-IN'; // Default to Hindi
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            
            // Visual feedback
            const micBtn = document.getElementById('mic-btn');
            micBtn.style.backgroundColor = '#ff4444';
            micBtn.textContent = 'üî¥';
            
            recognition.start();
            console.log('Speech recognition started');

            recognition.onresult = (event) => {
                const query = event.results[0][0].transcript;
                console.log('Voice input received:', query);
                addToHistory(query);
                sendQueryToBackend(query);
                
                // Reset button
                micBtn.style.backgroundColor = '#4CAF50';
                micBtn.textContent = 'üé§';
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                alert('Error capturing voice: ' + event.error);
                
                // Reset button
                micBtn.style.backgroundColor = '#4CAF50';
                micBtn.textContent = 'üé§';
            };
            
            recognition.onend = () => {
                console.log('Speech recognition ended');
                // Reset button
                micBtn.style.backgroundColor = '#4CAF50';
                micBtn.textContent = 'üé§';
            };
        }
        
        function showGreeting(text) {
            const responseArea = document.getElementById('response-area');
            const responseText = document.getElementById('response-text');
            responseArea.style.display = 'block';
            responseText.innerHTML = '<div style="text-align: center; color: #4CAF50;"><h3>üôè ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à!</h3><p>' + text + '</p></div>';
        }

        // Handle search input - Enter key press
        document.getElementById('search-input').addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                const query = event.target.value.trim();
                if (query) {
                    console.log('Text input received:', query);
                    addToHistory(query);
                    sendQueryToBackend(query);
                    event.target.value = ''; // Clear input after sending
                }
            }
        });

        // Add query to history
        function addToHistory(query) {
            const historyList = document.getElementById('history-list');
            const listItem = document.createElement('li');
            listItem.textContent = query;
            listItem.onclick = () => {
                console.log('Replaying query:', query);
                sendQueryToBackend(query);
            };
            historyList.insertBefore(listItem, historyList.firstChild); // Add to top
            
            // Limit history to 20 items
            if (historyList.children.length > 20) {
                historyList.removeChild(historyList.lastChild);
            }
        }

        // Send query to backend
        function sendQueryToBackend(query) {
            console.log('Sending query to backend:', query);
            
            // Show loading state
            const responseArea = document.getElementById('response-area');
            const responseText = document.getElementById('response-text');
            responseArea.style.display = 'block';
            responseText.innerHTML = '<div style="text-align: center;"><div class="spinner"></div><p>‡§Ü‡§™‡§ï‡•á ‡§∏‡§µ‡§æ‡§≤ ‡§ï‡§æ ‡§ú‡§µ‡§æ‡§¨ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...</p></div>';

            fetch('/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    query: query, 
                    session_id: sessionId 
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response from backend:', data);
                
                if (data.success) {
                    // Format response text with line breaks
                    const formattedText = data.text.replace(/\n/g, '<br>');
                    responseText.innerHTML = formattedText;
                    
                    // Play audio if available
                    if (data.audio_file) {
                        playAudioResponse(data.audio_file);
                    }
                    
                    // Show waiting message if waiting for news selection
                    if (data.waiting_for_news) {
                        responseText.innerHTML += '<br><br><em>‡§ï‡•É‡§™‡§Ø‡§æ ‡§ñ‡§¨‡§∞ ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§¨‡•ã‡§≤‡•á‡§Ç ‡§Ø‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç...</em>';
                    }
                } else {
                    responseText.innerHTML = '<div style="color: #d32f2f;">‚ùå Error: ' + (data.message || data.text || 'Unknown error occurred') + '</div>';
                }
            })
            .catch(error => {
                console.error('Error communicating with server:', error);
                responseText.innerHTML = '<div style="color: #d32f2f;">‚ùå Error communicating with server: ' + error.message + '<br><br>Please check if the server is running.</div>';
            });
        }

        // Play audio response
        function playAudioResponse(audioFile) {
            if (audioFile) {
                console.log('Attempting to play audio:', audioFile);
                const audioPlayer = document.getElementById('audio-player');
                
                // Reset player
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                
                // Set new source
                audioPlayer.src = audioFile;
                audioPlayer.style.display = 'block';
                
                // Add cache buster to force reload
                const cacheBuster = '?t=' + new Date().getTime();
                audioPlayer.src = audioFile + cacheBuster;
                
                // Load and play
                audioPlayer.load();
                
                // Attempt to play
                const playPromise = audioPlayer.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('‚úÖ Audio playback started successfully');
                    }).catch(error => {
                        console.error('‚ùå Audio playback error:', error);
                        console.log('Audio file URL:', audioFile);
                        
                        // Show error to user
                        alert('Audio playback failed. Error: ' + error.message + '\nPlease check browser console.');
                    });
                }
            } else {
                console.warn('No audio file provided');
            }
        }

        // Quick action functions
        function sendQuickQuery(actionType) {
            let query = '';
            
            switch(actionType) {
                case 'Weather':
                    query = '‡§Æ‡•å‡§∏‡§Æ ‡§ï‡•à‡§∏‡§æ ‡§π‡•à';
                    break;
                case 'News':
                    query = '‡§Ü‡§ú ‡§ï‡•Ä ‡§ñ‡§¨‡§∞‡•á‡§Ç ‡§¨‡§§‡§æ‡§ì';
                    break;
                case 'Schemes':
                    query = '‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç ‡§¨‡§§‡§æ‡§ì';
                    break;
                case 'Emergency':
                    query = '‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ö‡§æ‡§π‡§ø‡§è';
                    break;
                default:
                    query = actionType;
            }
            
            console.log('Quick action:', actionType, '-> Query:', query);
            addToHistory(query);
            sendQueryToBackend(query);
        }
    </script>
</body>
</html>
